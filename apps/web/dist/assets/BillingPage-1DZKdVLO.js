import{j as e,c as k,b as c,u as m}from"./query-BVapmMUr.js";import{r as _}from"./react-DJjQTIQO.js";import{P as C}from"./PageHeader-o_TcEL5P.js";import{S as h}from"./StatusBadge-DqFGVLZ6.js";import{M as b}from"./MoneyDisplay-DJnLbf4O.js";import{c as v}from"./cn-C8nBGPD0.js";import{E as w}from"./EmptyState-CZ0oPKrL.js";import{s as S,a as E,b as P,c as z,g as q,d as K,e as M,f as F}from"./billing-By_ry0nH.js";import{b as g,g as R,Z as j,K as $,M as B,t as i}from"./ui--RxPHpVv.js";import"./client-DPKpE0-G.js";import"./index-CwauQ0k6.js";import"./state-B9IHhQuw.js";function L({events:n,maxHeight:a="400px",emptyMessage:u="No events"}){return n.length===0?e.jsx("p",{className:"py-6 text-center text-sm text-muted-foreground",children:u}):e.jsx("div",{className:"overflow-y-auto space-y-0.5",style:{maxHeight:a},children:n.map((r,t)=>e.jsxs("div",{className:v("group relative flex gap-3 py-2.5 pl-6",t<n.length-1&&"border-l border-border"),children:[e.jsx("div",{className:"absolute left-0 top-3.5 -translate-x-1/2 h-2.5 w-2.5 rounded-full border-2 border-surface bg-muted-foreground group-hover:bg-primary transition-colors"}),e.jsxs("div",{className:"flex flex-1 items-start justify-between gap-3",children:[e.jsxs("div",{className:"min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(h,{status:r.type,size:"sm"}),r.label&&e.jsx("span",{className:"truncate text-xs text-muted-foreground",children:r.label})]}),r.detail&&e.jsx("p",{className:"mt-0.5 truncate text-xs text-muted",children:r.detail})]}),e.jsxs("div",{className:"shrink-0 text-right",children:[r.amount&&e.jsx("p",{className:"font-mono text-sm font-semibold",children:typeof r.amount=="number"?`$${r.amount.toFixed(2)}`:r.amount}),e.jsx("p",{className:"text-xs text-muted",children:new Date(r.timestamp).toLocaleString()})]})]})]},r.id))})}function W(){const n=k(),[a,u]=_.useState(""),{data:r}=c({queryKey:["billing-subscription"],queryFn:q}),{data:t}=c({queryKey:["billing-provider"],queryFn:K}),{data:x}=c({queryKey:["billing-policy"],queryFn:M}),{data:p=[]}=c({queryKey:["billing-ledger"],queryFn:F}),o=()=>{n.invalidateQueries({queryKey:["billing-subscription"]}),n.invalidateQueries({queryKey:["billing-ledger"]})},f=m({mutationFn:()=>S(a?{idempotency_key:a}:{}),onSuccess:s=>{if(s.checkout_url){window.location.href=s.checkout_url;return}o(),i.success(`Subscription: ${s.event_type??s.status??"processed"}${s.idempotency_status?` (${s.idempotency_status})`:""}`)},onError:s=>i.error(s instanceof Error?s.message:"Simulation failed")}),d=m({mutationFn:()=>P({estimate_id:"manual",...a?{idempotency_key:a}:{}}),onSuccess:s=>{o(),i.success(`Charge: ${s.amount}`)},onError:s=>i.error(s instanceof Error?s.message:"Charge failed")}),l=m({mutationFn:s=>E({event_type:s,...a?{idempotency_key:a}:{}}),onSuccess:s=>{o(),i.success(`Event: ${s.event_type}`)},onError:s=>i.error(s instanceof Error?s.message:"Event failed")}),y=m({mutationFn:()=>z(a?{idempotency_key:a}:{}),onSuccess:s=>{o(),i.success(`Refund: ${s.amount}`)},onError:s=>i.error(s instanceof Error?s.message:"Refund failed")}),N=p.map(s=>({id:s.id,type:s.event_type,amount:s.amount,detail:s.details,timestamp:s.created_at}));return e.jsxs("div",{className:"space-y-6",children:[e.jsx(C,{title:"Billing",description:"Manage subscriptions and usage charges",icon:g}),t&&e.jsxs("div",{className:"flex items-center gap-3 rounded-xl border border-border bg-surface/80 px-4 py-3 text-sm backdrop-blur-sm",children:[e.jsx("span",{className:v("inline-block h-2.5 w-2.5 shrink-0 rounded-full",t.adapter_ready?"bg-success":"bg-destructive")}),e.jsxs("span",{className:"font-medium",children:["Provider: ",t.provider]}),e.jsxs("span",{className:"text-muted-foreground",children:["• Mode: ",t.live_mode]}),t.blocker_reason&&e.jsxs("span",{className:"flex items-center gap-1 text-warning",children:[e.jsx(R,{size:12})," ",t.blocker_reason]})]}),e.jsxs("div",{className:"grid gap-6 lg:grid-cols-2",children:[e.jsxs("div",{className:"rounded-2xl border border-border bg-surface/80 p-6 backdrop-blur-sm",children:[e.jsx("h2",{className:"mb-4 font-heading text-base font-semibold",children:"Subscription"}),r?e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{className:"rounded-xl border border-border bg-background/50 p-3",children:[e.jsx("p",{className:"text-xs text-muted-foreground",children:"Status"}),e.jsx("div",{className:"mt-1.5",children:e.jsx(h,{status:r.status,size:"md"})})]}),e.jsxs("div",{className:"rounded-xl border border-border bg-background/50 p-3",children:[e.jsx("p",{className:"text-xs text-muted-foreground",children:"Annual Amount"}),e.jsx(b,{value:r.annual_subscription_amount,size:"lg",className:"mt-1"})]})]}),r.last_event_type&&e.jsxs("div",{className:"rounded-xl border border-border bg-background/50 p-3",children:[e.jsx("p",{className:"text-xs text-muted-foreground",children:"Last Event"}),e.jsxs("div",{className:"mt-1 flex items-center gap-2",children:[e.jsx(h,{status:r.last_event_type,size:"sm"}),r.last_event_amount&&e.jsx(b,{value:r.last_event_amount,size:"sm"})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("p",{className:"text-xs font-medium uppercase tracking-wider text-muted",children:"Lifecycle Actions"}),(t==null?void 0:t.provider)==="stripe"?e.jsxs("div",{className:"flex flex-col gap-2",children:[e.jsxs("button",{onClick:()=>f.mutate(),className:"flex justify-center items-center gap-2 rounded-xl bg-primary px-3 py-2.5 text-xs font-semibold text-primary-foreground shadow-md hover:bg-primary-hover",children:[e.jsx(g,{size:14})," Subscribe via Stripe"]}),e.jsx("p",{className:"text-[10px] text-muted-foreground text-center",children:"Managed securely via Stripe Checkout."})]}):e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsx("button",{onClick:()=>l.mutate("payment_method_attached"),className:"rounded-xl border border-border bg-surface-hover px-3 py-2 text-xs font-medium text-foreground shadow-none hover:bg-surface-active",children:"Attach Card"}),e.jsx("button",{onClick:()=>f.mutate(),className:"rounded-xl border border-border bg-surface-hover px-3 py-2 text-xs font-medium text-foreground shadow-none hover:bg-surface-active",children:"Complete Checkout"}),e.jsx("button",{onClick:()=>l.mutate("invoice_paid"),className:"rounded-xl border border-border bg-surface-hover px-3 py-2 text-xs font-medium text-foreground shadow-none hover:bg-surface-active",children:"Invoice Paid"}),e.jsx("button",{onClick:()=>l.mutate("invoice_payment_failed"),className:"rounded-xl border border-warning/30 bg-warning/10 px-3 py-2 text-xs font-medium text-warning shadow-none hover:bg-warning/20",children:"Payment Failed"}),e.jsx("button",{onClick:()=>l.mutate("subscription_canceled"),className:"col-span-2 rounded-xl border border-destructive/30 bg-destructive/10 px-3 py-2 text-xs font-medium text-destructive shadow-none hover:bg-destructive/20",children:"Cancel Subscription"})]})]})]}):e.jsx("div",{className:"space-y-3",children:[1,2].map(s=>e.jsx("div",{className:"animate-skeleton h-16 rounded-xl bg-border"},s))})]}),e.jsxs("div",{className:"rounded-2xl border border-border bg-surface/80 p-6 backdrop-blur-sm",children:[e.jsx("h2",{className:"mb-4 font-heading text-base font-semibold",children:"Usage Charges"}),e.jsxs("div",{className:"space-y-4",children:[x&&e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{className:"rounded-xl border border-border bg-background/50 p-3",children:[e.jsx("p",{className:"text-xs text-muted-foreground",children:"Per Pricing Run"}),e.jsx(b,{value:x.realtime_pricing_amount,size:"lg",className:"mt-1"})]}),e.jsxs("div",{className:"rounded-xl border border-border bg-background/50 p-3",children:[e.jsx("p",{className:"text-xs text-muted-foreground",children:"Currency"}),e.jsx("p",{className:"mt-1 text-lg font-semibold uppercase",children:x.currency})]})]}),(t==null?void 0:t.provider)==="stripe"?e.jsx("div",{className:"grid grid-cols-1 gap-2",children:e.jsxs("button",{onClick:()=>d.mutate(),disabled:d.isPending,className:"flex items-center justify-center gap-2 rounded-xl border border-primary/30 bg-primary/10 px-3 py-2.5 text-xs font-semibold text-primary shadow-none hover:bg-primary/20 disabled:opacity-50",children:[e.jsx(j,{size:14})," Capture Live Usage Charge"]})}):e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsxs("button",{onClick:()=>d.mutate(),disabled:d.isPending,className:"flex items-center justify-center gap-2 rounded-xl border border-primary/30 bg-primary/10 px-3 py-2.5 text-xs font-semibold text-primary shadow-none hover:bg-primary/20 disabled:opacity-50",children:[e.jsx(j,{size:14})," Run Charge"]}),e.jsxs("button",{onClick:()=>y.mutate(),disabled:y.isPending,className:"flex items-center justify-center gap-2 rounded-xl border border-border bg-surface-hover px-3 py-2.5 text-xs font-medium text-foreground shadow-none hover:bg-surface-active disabled:opacity-50",children:[e.jsx($,{size:14})," Refund"]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("label",{className:"flex items-center gap-1.5 text-xs font-medium text-muted-foreground",children:[e.jsx(B,{size:12})," Idempotency Key (optional)"]}),e.jsx("input",{value:a,onChange:s=>u(s.target.value),placeholder:"e.g. test-key-123",className:"w-full rounded-xl border border-input-border bg-input px-3 py-2.5 text-sm font-mono placeholder:text-muted outline-none focus:border-primary focus:ring-2 focus:ring-primary/20"}),e.jsx("p",{className:"text-xs text-muted",children:"Set a key to test idempotency — replaying the same key returns the cached result."})]})]})]})]}),e.jsxs("div",{className:"rounded-2xl border border-border bg-surface/80 p-6 backdrop-blur-sm",children:[e.jsxs("h2",{className:"mb-4 font-heading text-base font-semibold",children:["Billing Ledger (",p.length,")"]}),p.length===0?e.jsx(w,{icon:g,title:"No billing events yet",description:"Use the simulation controls above to generate events"}):e.jsx(L,{events:N,maxHeight:"500px"})]})]})}export{W as BillingPage};
