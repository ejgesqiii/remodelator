import{b as C,u as h,j as e,c as R}from"./query-BVapmMUr.js";import{r as p,h as ue,L as A}from"./react-DJjQTIQO.js";import{P as xe}from"./PageHeader-o_TcEL5P.js";import{S as pe}from"./StatusBadge-DqFGVLZ6.js";import{M as D}from"./MoneyDisplay-DJnLbf4O.js";import{b as k,E as ge,c as be}from"./EmptyState-CZ0oPKrL.js";import{c as Q}from"./cn-C8nBGPD0.js";import{q as he,u as fe,a as je,b as ve,r as ye,d as Ne,e as _e,f as ke,v as we,g as Ce,h as Se,s as Ee,i as Fe}from"./estimates-D7lOcU5t.js";import{g as ee,u as ze,s as qe}from"./useDebounce-D14sap1U.js";import{t as u,B as Le,g as Pe,n as Ie,o as Me,p as Ae,X as T,Z as z,q as te,r as De,C as Z,s as X,l as W,P as Qe,m as Re,u as Y,v as Te,w as Ue,x as Ke,R as $e,y as Oe,G as Be,D as Ge,z as He,H as Je,I as Ve}from"./ui-D1pQdlX7.js";import{a as Ze,b as Xe,g as We}from"./llm-DZNYVEJB.js";import"./client-Bw5oB_ZD.js";import"./index-D_Pr5PJx.js";import"./state-BAZDGeK2.js";function Ye({estimateId:n,lineItems:m,onApplied:r}){const[f,i]=p.useState(null),[j,x]=p.useState(""),{data:o}=C({queryKey:["llm-status"],queryFn:We,staleTime:6e4}),d=h({mutationFn:l=>Ze({item_name:l.item_name,current_unit_price:parseFloat(l.unit_price),context:j||void 0})}),a=h({mutationFn:l=>Xe({estimate_id:n,line_item_id:l.line_item_id,suggested_price:l.suggested_price}),onSuccess:()=>{u.success("Price suggestion applied"),i(null),d.reset(),r()},onError:l=>u.error(l instanceof Error?l.message:"Apply failed")}),s=m.find(l=>l.id===f),b=(o==null?void 0:o.api_key_configured)&&(o==null?void 0:o.ready_for_live),g=d.data;return e.jsxs("div",{className:"rounded-2xl border border-border bg-surface/80 p-6 backdrop-blur-sm",children:[e.jsxs("div",{className:"mb-4 flex items-center justify-between",children:[e.jsxs("h3",{className:"flex items-center gap-2 font-heading text-base font-semibold",children:[e.jsx(Le,{size:18,className:"text-accent"}),"LLM Assist"]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:Q("inline-block h-2 w-2 rounded-full",b?"bg-success":o!=null&&o.simulation_available?"bg-warning":"bg-destructive")}),e.jsx("span",{className:"text-xs text-muted-foreground",children:b?"Live":o!=null&&o.simulation_available?"Simulation":"Offline"})]})]}),(o==null?void 0:o.blocker_reason)&&e.jsxs("div",{className:"mb-3 rounded-xl border border-warning/30 bg-warning-muted px-3 py-2 text-xs text-warning",children:[e.jsx(Pe,{size:12,className:"mr-1 inline"}),o.blocker_reason]}),e.jsxs("div",{className:"mb-3 space-y-2",children:[e.jsx("label",{className:"text-xs font-medium text-muted-foreground",children:"Select line item"}),e.jsxs("select",{value:f||"",onChange:l=>{i(l.target.value||null),d.reset()},className:"w-full rounded-xl border border-input-border bg-input px-3 py-2.5 text-sm outline-none focus:border-primary focus:ring-2 focus:ring-primary/20",children:[e.jsx("option",{value:"",children:"Choose an item..."}),m.map(l=>e.jsxs("option",{value:l.id,children:[l.item_name," — ",k(l.unit_price)]},l.id))]})]}),e.jsxs("div",{className:"mb-3 space-y-2",children:[e.jsx("label",{className:"text-xs font-medium text-muted-foreground",children:"Context (optional)"}),e.jsx("input",{value:j,onChange:l=>x(l.target.value),placeholder:"e.g. mid-range, commercial grade",className:"w-full rounded-xl border border-input-border bg-input px-3 py-2.5 text-sm placeholder:text-muted outline-none focus:border-primary focus:ring-2 focus:ring-primary/20"})]}),e.jsxs("button",{disabled:!s||d.isPending,onClick:()=>s&&d.mutate(s),className:"flex w-full items-center justify-center gap-2 rounded-xl bg-accent/15 px-4 py-2.5 text-sm font-semibold text-accent shadow-none transition-colors hover:bg-accent/25 disabled:opacity-40",children:[d.isPending?e.jsx(Ie,{size:16,className:"animate-spin"}):e.jsx(Me,{size:16}),"Get Price Suggestion"]}),g&&e.jsxs("div",{className:"mt-4 rounded-xl border border-accent/20 bg-accent/5 p-4",children:[e.jsxs("div",{className:"mb-3 flex items-center justify-between",children:[e.jsx("span",{className:"text-xs font-medium uppercase tracking-wider text-muted",children:"Suggestion"}),g.confidence&&e.jsxs("span",{className:"rounded-full bg-accent/15 px-2 py-0.5 text-xs font-semibold text-accent",children:[g.confidence," confidence"]})]}),e.jsxs("div",{className:"mb-2 grid grid-cols-2 gap-2 text-sm",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-muted-foreground",children:"Current"}),e.jsx("p",{className:"font-mono font-semibold",children:k(g.current_unit_price)})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-muted-foreground",children:"Suggested"}),e.jsx("p",{className:"font-mono font-semibold text-accent",children:k(g.suggested_unit_price)})]})]}),g.rationale&&e.jsx("p",{className:"mb-3 text-xs text-muted-foreground",children:g.rationale}),g.provider&&e.jsxs("p",{className:"mb-3 text-xs text-muted",children:["via ",g.provider,"/",g.model," (",g.mode,")"]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs("button",{onClick:()=>a.mutate({line_item_id:f,suggested_price:parseFloat(g.suggested_unit_price)}),disabled:a.isPending,className:"flex flex-1 items-center justify-center gap-1.5 rounded-xl bg-accent px-3 py-2 text-xs font-semibold text-accent-foreground shadow-md transition-colors hover:bg-accent/90 disabled:opacity-50",children:[e.jsx(Ae,{size:14})," Apply"]}),e.jsxs("button",{onClick:()=>d.reset(),className:"flex items-center gap-1.5 rounded-xl bg-surface-hover px-3 py-2 text-xs font-medium text-muted-foreground shadow-none transition-colors hover:text-foreground",children:[e.jsx(T,{size:14})," Dismiss"]})]})]}),d.isError&&e.jsx("div",{className:"mt-3 rounded-xl border border-destructive/20 bg-destructive-muted px-3 py-2 text-xs text-destructive",children:d.error instanceof Error?d.error.message:"Suggestion failed"})]})}function et({estimateId:n,open:m,onClose:r}){const f=R(),[i,j]=p.useState(""),[x,o]=p.useState("10"),{data:d=[]}=C({queryKey:["catalog-tree"],queryFn:ee,enabled:m}),a=h({mutationFn:()=>he(n,{catalog_node_name:i,max_items:parseInt(x)||void 0}),onSuccess:()=>{f.invalidateQueries({queryKey:["estimate",n]}),f.invalidateQueries({queryKey:["estimates"]}),u.success("Starter items added!"),r()},onError:s=>u.error(s instanceof Error?s.message:"Quickstart failed")});return m?e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-background/80 backdrop-blur-sm",children:e.jsxs("div",{className:"w-full max-w-md rounded-2xl border border-border bg-surface p-6 shadow-lg",children:[e.jsxs("div",{className:"mb-4 flex items-center justify-between",children:[e.jsxs("h3",{className:"flex items-center gap-2 font-heading text-lg font-semibold",children:[e.jsx(z,{size:20,className:"text-warning"}),"Quick Start"]}),e.jsx("button",{onClick:r,className:"rounded-lg bg-transparent p-1.5 text-muted shadow-none transition-colors hover:bg-surface-hover hover:text-foreground",children:e.jsx(T,{size:18})})]}),e.jsx("p",{className:"mb-4 text-sm text-muted-foreground",children:"Populate this estimate with common items from a catalog category."}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium",children:"Room / Category"}),e.jsxs("select",{value:i,onChange:s=>j(s.target.value),className:"w-full rounded-xl border border-input-border bg-input px-4 py-3 text-sm outline-none focus:border-primary focus:ring-2 focus:ring-primary/20",children:[e.jsx("option",{value:"",children:"Select a category..."}),d.map(s=>e.jsxs("option",{value:s.name,children:[s.name," (",s.items.length," items)"]},s.name))]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium",children:"Max Items"}),e.jsx("input",{type:"number",min:"1",max:"50",value:x,onChange:s=>o(s.target.value),className:"w-full rounded-xl border border-input-border bg-input px-4 py-3 text-sm outline-none focus:border-primary focus:ring-2 focus:ring-primary/20"})]}),e.jsxs("div",{className:"flex gap-3 pt-2",children:[e.jsxs("button",{onClick:()=>a.mutate(),disabled:!i||a.isPending,className:"flex flex-1 items-center justify-center gap-2 rounded-xl bg-primary px-4 py-3 text-sm font-semibold text-primary-foreground shadow-lg shadow-primary/20 transition-all hover:bg-primary-hover disabled:opacity-50",children:[a.isPending?e.jsx("div",{className:"h-4 w-4 animate-spin rounded-full border-2 border-primary-foreground/30 border-t-primary-foreground"}):e.jsx(z,{size:16}),"Add Items"]}),e.jsx("button",{onClick:r,className:"rounded-xl bg-transparent px-4 py-3 text-sm font-medium text-muted-foreground shadow-none transition-colors hover:text-foreground",children:"Cancel"})]})]})]})}):null}function tt({estimateId:n,lineItem:m,onClose:r}){const f=R(),[i,j]=p.useState({quantity:m.quantity,unit_price:m.unit_price,item_markup_pct:m.item_markup_pct,labor_hours:m.labor_hours,labor_rate:m.labor_rate,discount_value:m.discount_value,discount_is_percent:m.discount_is_percent,group_name:m.group_name}),x=h({mutationFn:()=>fe(n,m.id,{quantity:parseFloat(i.quantity)||void 0,unit_price:parseFloat(i.unit_price)||void 0,item_markup_pct:parseFloat(i.item_markup_pct)||void 0,labor_hours:parseFloat(i.labor_hours)||void 0,discount_value:parseFloat(i.discount_value)||void 0,discount_is_percent:i.discount_is_percent,group_name:i.group_name||void 0}),onSuccess:()=>{f.invalidateQueries({queryKey:["estimate",n]}),f.invalidateQueries({queryKey:["estimates"]}),u.success(`${m.item_name} updated`),r()},onError:a=>u.error(a instanceof Error?a.message:"Update failed")}),o=(a,s)=>{j(b=>({...b,[a]:s}))},d="w-full rounded-xl border border-input-border bg-input px-3 py-2.5 text-sm outline-none transition-colors focus:border-primary focus:ring-2 focus:ring-primary/20";return e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-background/80 backdrop-blur-sm",children:e.jsxs("div",{className:"w-full max-w-lg rounded-2xl border border-border bg-surface p-6 shadow-lg",children:[e.jsxs("div",{className:"mb-4 flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"font-heading text-lg font-semibold",children:m.item_name}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:["Current total: ",k(m.total_price)]})]}),e.jsx("button",{onClick:r,className:"rounded-lg bg-transparent p-1.5 text-muted shadow-none transition-colors hover:bg-surface-hover hover:text-foreground",children:e.jsx(T,{size:18})})]}),e.jsxs("form",{onSubmit:a=>{a.preventDefault(),x.mutate()},className:"space-y-4",children:[e.jsxs("div",{className:"grid gap-4 sm:grid-cols-2",children:[e.jsxs("div",{className:"space-y-1.5",children:[e.jsx("label",{className:"text-xs font-medium text-muted-foreground",children:"Quantity"}),e.jsx("input",{type:"number",step:"any",value:i.quantity,onChange:a=>o("quantity",a.target.value),className:d})]}),e.jsxs("div",{className:"space-y-1.5",children:[e.jsx("label",{className:"text-xs font-medium text-muted-foreground",children:"Unit Price ($)"}),e.jsx("input",{type:"number",step:"0.01",value:i.unit_price,onChange:a=>o("unit_price",a.target.value),className:d})]}),e.jsxs("div",{className:"space-y-1.5",children:[e.jsx("label",{className:"text-xs font-medium text-muted-foreground",children:"Markup %"}),e.jsx("input",{type:"number",step:"any",value:i.item_markup_pct,onChange:a=>o("item_markup_pct",a.target.value),className:d})]}),e.jsxs("div",{className:"space-y-1.5",children:[e.jsx("label",{className:"text-xs font-medium text-muted-foreground",children:"Labor Hours"}),e.jsx("input",{type:"number",step:"any",value:i.labor_hours,onChange:a=>o("labor_hours",a.target.value),className:d})]}),e.jsxs("div",{className:"space-y-1.5",children:[e.jsx("label",{className:"text-xs font-medium text-muted-foreground",children:"Discount"}),e.jsx("input",{type:"number",step:"any",value:i.discount_value,onChange:a=>o("discount_value",a.target.value),className:d})]}),e.jsxs("div",{className:"space-y-1.5",children:[e.jsx("label",{className:"text-xs font-medium text-muted-foreground",children:"Discount Type"}),e.jsxs("select",{value:i.discount_is_percent?"percent":"flat",onChange:a=>o("discount_is_percent",a.target.value==="percent"),className:d,children:[e.jsx("option",{value:"flat",children:"Flat ($)"}),e.jsx("option",{value:"percent",children:"Percent (%)"})]})]})]}),e.jsxs("div",{className:"space-y-1.5",children:[e.jsx("label",{className:"text-xs font-medium text-muted-foreground",children:"Group"}),e.jsx("input",{value:i.group_name,onChange:a=>o("group_name",a.target.value),placeholder:"e.g. Plumbing",className:d})]}),e.jsxs("div",{className:"flex gap-3 pt-2",children:[e.jsxs("button",{type:"submit",disabled:x.isPending,className:"flex flex-1 items-center justify-center gap-2 rounded-xl bg-primary px-4 py-3 text-sm font-semibold text-primary-foreground shadow-lg shadow-primary/20 transition-all hover:bg-primary-hover disabled:opacity-50",children:[x.isPending?e.jsx("div",{className:"h-4 w-4 animate-spin rounded-full border-2 border-primary-foreground/30 border-t-primary-foreground"}):e.jsx(te,{size:16}),"Save Changes"]}),e.jsx("button",{type:"button",onClick:r,className:"rounded-xl bg-transparent px-4 py-3 text-sm font-medium text-muted-foreground shadow-none transition-colors hover:text-foreground",children:"Cancel"})]})]})]})})}function bt(){const{id:n}=ue(),m=R(),{data:r,isLoading:f}=C({queryKey:["estimate",n],queryFn:()=>Fe(n),enabled:!!n}),[i,j]=p.useState(!1),[x,o]=p.useState({customer_name:"",customer_email:"",customer_phone:"",job_address:"",estimate_markup_pct:"",tax_rate_pct:""}),[d,a]=p.useState(!1),[s,b]=p.useState({item_name:"",quantity:"",unit_price:"",labor_hours:"0",item_markup_pct:"0",discount_value:"0",group_name:""}),[g,l]=p.useState(""),[se,U]=p.useState(new Set),[S,K]=p.useState(null),[$,re]=p.useState(!1),N=ze(g,250),[ae,q]=p.useState(!1),[O,L]=p.useState(null),{data:E=[],isLoading:oe}=C({queryKey:["catalog-tree"],queryFn:ee,enabled:d}),{data:ne=[]}=C({queryKey:["catalog-search",N],queryFn:()=>qe(N),enabled:d&&N.length>=2}),ie=()=>{b({item_name:"",quantity:"",unit_price:"",labor_hours:"0",item_markup_pct:"0",discount_value:"0",group_name:""})},F=()=>{a(!1),l(""),K(null),U(new Set),ie()},y=()=>{m.invalidateQueries({queryKey:["estimate",n]}),m.invalidateQueries({queryKey:["estimates"]})},B=h({mutationFn:t=>je(n,t),onSuccess:()=>{y(),j(!1),u.success("Estimate updated")},onError:t=>u.error(t instanceof Error?t.message:"Update failed")}),w=h({mutationFn:t=>ve(n,t),onSuccess:()=>{y(),u.success("Line item added")},onError:t=>u.error(t instanceof Error?t.message:"Failed to add item")}),de=h({mutationFn:t=>Ne(n,t),onSuccess:()=>{y(),u.success("Line item removed")},onError:t=>u.error(t instanceof Error?t.message:"Failed to remove item")}),G=h({mutationFn:({lineItemId:t,direction:c})=>ye(n,t,c),onSuccess:()=>y()}),H=h({mutationFn:()=>_e(n),onSuccess:()=>{y(),u.success("Totals recalculated")},onError:t=>u.error(t instanceof Error?t.message:"Recalc failed")}),J=h({mutationFn:()=>Se(n),onSuccess:t=>{const c=new Blob([JSON.stringify(t,null,2)],{type:"application/json"}),v=URL.createObjectURL(c),M=document.createElement("a");M.href=v,M.download=`estimate-${n}.json`,M.click(),URL.revokeObjectURL(v),u.success("Estimate exported")},onError:t=>u.error(t instanceof Error?t.message:"Export failed")}),P=h({mutationFn:t=>{switch(t){case"duplicate":return Ce(n);case"version":return we(n);case"unlock":return ke(n);default:return Promise.reject(new Error("Unknown action"))}},onSuccess:(t,c)=>{y(),u.success(`Estimate ${c==="duplicate"?"duplicated":c==="version"?"versioned":"unlocked"}`)},onError:t=>u.error(t instanceof Error?t.message:"Action failed")}),I=h({mutationFn:t=>Ee(n,t),onSuccess:()=>{y(),u.success("Status updated")},onError:t=>u.error(t instanceof Error?t.message:"Status update failed")}),le=t=>{U(c=>{const v=new Set(c);return v.has(t)?v.delete(t):v.add(t),v})},ce=p.useMemo(()=>{if(!S)return[];const t=E.find(c=>c.name===S);return(t==null?void 0:t.items)??[]},[S,E]),V=N.length>=2?ne:ce,me=t=>{w.mutate({item_name:t.name,quantity:1,unit_price:parseFloat(t.unit_price??"0")||0,labor_hours:parseFloat(t.labor_hours??"0")||0,item_markup_pct:parseFloat(s.item_markup_pct)||0,discount_value:0,group_name:s.group_name||void 0},{onSuccess:()=>{if($){F();return}b(c=>({...c,item_name:t.name,quantity:"1",unit_price:t.unit_price??c.unit_price,labor_hours:t.labor_hours??c.labor_hours}))}})};if(f)return e.jsxs("div",{className:"space-y-6",children:[e.jsx("div",{className:"animate-skeleton h-10 w-1/3 rounded-xl bg-border"}),e.jsxs("div",{className:"grid gap-6 lg:grid-cols-3",children:[e.jsxs("div",{className:"space-y-6 lg:col-span-2",children:[e.jsx("div",{className:"animate-skeleton h-48 rounded-2xl bg-border"}),e.jsx("div",{className:"animate-skeleton h-72 rounded-2xl bg-border"})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"animate-skeleton h-40 rounded-2xl bg-border"}),e.jsx("div",{className:"animate-skeleton h-56 rounded-2xl bg-border"})]})]})]});if(!r)return e.jsxs("div",{className:"flex flex-col items-center py-20 text-center",children:[e.jsx("p",{className:"text-lg text-muted-foreground",children:"Estimate not found"}),e.jsx(A,{to:"/estimates",className:"mt-4 text-sm text-primary hover:underline",children:"Back to estimates"})]});const _=r.line_items||[];return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(A,{to:"/estimates",className:"rounded-lg p-2 text-muted transition-colors hover:bg-surface-hover hover:text-foreground",children:e.jsx(De,{size:20})}),e.jsx(xe,{title:r.title,icon:Z,actions:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(pe,{status:r.status,size:"md"}),e.jsxs("span",{className:"font-mono text-sm text-muted-foreground",children:["v",r.version]})]})})]}),e.jsxs("div",{className:"grid gap-6 lg:grid-cols-3",children:[e.jsxs("div",{className:"space-y-6 lg:col-span-2",children:[e.jsxs("div",{className:"rounded-2xl border border-border bg-surface/80 p-6 backdrop-blur-sm",children:[e.jsxs("div",{className:"mb-4 flex items-center justify-between",children:[e.jsx("h2",{className:"font-heading text-base font-semibold",children:"Customer & Project"}),e.jsx("button",{onClick:()=>{i||o({customer_name:r.customer_name||"",customer_email:r.customer_email||"",customer_phone:r.customer_phone||"",job_address:r.job_address||"",estimate_markup_pct:r.estimate_markup_pct||"",tax_rate_pct:r.tax_rate_pct||""}),j(!i)},className:"rounded-lg bg-transparent p-2 text-muted shadow-none transition-colors hover:bg-surface-hover hover:text-foreground",children:e.jsx(X,{size:16})})]}),i?e.jsxs("form",{onSubmit:t=>{t.preventDefault(),B.mutate({customer_name:x.customer_name,customer_email:x.customer_email,customer_phone:x.customer_phone,job_address:x.job_address,estimate_markup_pct:x.estimate_markup_pct?parseFloat(x.estimate_markup_pct):void 0,tax_rate_pct:x.tax_rate_pct?parseFloat(x.tax_rate_pct):void 0})},className:"space-y-3",children:[e.jsx("div",{className:"grid gap-3 sm:grid-cols-2",children:["customer_name","customer_email","customer_phone","job_address","estimate_markup_pct","tax_rate_pct"].map(t=>e.jsx("input",{value:x[t],onChange:c=>o({...x,[t]:c.target.value}),placeholder:t.replace(/_/g," ").replace(/\b\w/g,c=>c.toUpperCase()),className:"w-full rounded-xl border border-input-border bg-input px-4 py-2.5 text-sm text-foreground placeholder:text-muted outline-none focus:border-primary focus:ring-2 focus:ring-primary/20"},t))}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs("button",{type:"submit",disabled:B.isPending,className:"flex items-center gap-2 rounded-xl bg-primary px-4 py-2 text-sm font-semibold text-primary-foreground shadow-md hover:bg-primary-hover disabled:opacity-50",children:[e.jsx(te,{size:14})," Save"]}),e.jsx("button",{type:"button",onClick:()=>j(!1),className:"rounded-xl bg-transparent px-4 py-2 text-sm text-muted-foreground shadow-none hover:text-foreground",children:"Cancel"})]})]}):e.jsxs("div",{className:"grid gap-x-8 gap-y-2 text-sm sm:grid-cols-2",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-muted-foreground",children:"Customer:"})," ",e.jsx("span",{className:"font-medium",children:r.customer_name||"—"})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-muted-foreground",children:"Email:"})," ",e.jsx("span",{className:"font-medium",children:r.customer_email||"—"})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-muted-foreground",children:"Phone:"})," ",e.jsx("span",{className:"font-medium",children:r.customer_phone||"—"})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-muted-foreground",children:"Address:"})," ",e.jsx("span",{className:"font-medium",children:r.job_address||"—"})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-muted-foreground",children:"Markup:"})," ",e.jsxs("span",{className:"font-medium",children:[r.estimate_markup_pct||"0","%"]})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-muted-foreground",children:"Tax Rate:"})," ",e.jsxs("span",{className:"font-medium",children:[r.tax_rate_pct||"0","%"]})]})]})]}),e.jsxs("div",{className:"rounded-2xl border border-border bg-surface/80 p-6 backdrop-blur-sm",children:[e.jsxs("div",{className:"mb-4 flex items-center justify-between",children:[e.jsxs("h2",{className:"font-heading text-base font-semibold",children:["Line Items (",_.length,")"]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("button",{onClick:()=>q(!0),className:"flex items-center gap-1.5 rounded-xl border border-warning/30 bg-warning/10 px-3 py-2 text-xs font-semibold text-warning shadow-none transition-colors hover:bg-warning/20",children:[e.jsx(z,{size:14})," Quick Start"]}),e.jsxs("button",{onClick:()=>{if(d){F();return}a(!0)},className:"flex items-center gap-1.5 rounded-xl bg-primary px-3 py-2 text-xs font-semibold text-primary-foreground shadow-md hover:bg-primary-hover",children:[e.jsx(W,{size:14})," Add Item"]})]})]}),d&&e.jsxs("div",{className:"mb-4 grid gap-4 rounded-xl border border-primary/20 bg-background/50 p-4 lg:grid-cols-2",children:[e.jsxs("form",{onSubmit:t=>{t.preventDefault(),w.mutate({item_name:s.item_name,quantity:parseFloat(s.quantity)||1,unit_price:parseFloat(s.unit_price)||0,labor_hours:parseFloat(s.labor_hours)||0,item_markup_pct:parseFloat(s.item_markup_pct)||0,discount_value:parseFloat(s.discount_value)||0,group_name:s.group_name||void 0},{onSuccess:()=>{F()}})},className:"space-y-3 rounded-xl border border-border bg-surface/60 p-4",children:[e.jsx("h3",{className:"font-heading text-sm font-semibold",children:"Manual Line Item"}),e.jsxs("div",{className:"grid gap-3 sm:grid-cols-2",children:[e.jsx("input",{value:s.item_name,onChange:t=>b({...s,item_name:t.target.value}),placeholder:"Item name *",required:!0,className:"w-full rounded-xl border border-input-border bg-input px-3 py-2.5 text-sm placeholder:text-muted outline-none focus:border-primary focus:ring-2 focus:ring-primary/20"}),e.jsx("input",{value:s.quantity,onChange:t=>b({...s,quantity:t.target.value}),placeholder:"Quantity",type:"number",step:"any",className:"w-full rounded-xl border border-input-border bg-input px-3 py-2.5 text-sm placeholder:text-muted outline-none focus:border-primary focus:ring-2 focus:ring-primary/20"}),e.jsx("input",{value:s.unit_price,onChange:t=>b({...s,unit_price:t.target.value}),placeholder:"Unit price",type:"number",step:"0.01",className:"w-full rounded-xl border border-input-border bg-input px-3 py-2.5 text-sm placeholder:text-muted outline-none focus:border-primary focus:ring-2 focus:ring-primary/20"}),e.jsx("input",{value:s.labor_hours,onChange:t=>b({...s,labor_hours:t.target.value}),placeholder:"Labor hours",type:"number",step:"any",className:"w-full rounded-xl border border-input-border bg-input px-3 py-2.5 text-sm placeholder:text-muted outline-none focus:border-primary focus:ring-2 focus:ring-primary/20"}),e.jsx("input",{value:s.item_markup_pct,onChange:t=>b({...s,item_markup_pct:t.target.value}),placeholder:"Markup %",type:"number",step:"any",className:"w-full rounded-xl border border-input-border bg-input px-3 py-2.5 text-sm placeholder:text-muted outline-none focus:border-primary focus:ring-2 focus:ring-primary/20"}),e.jsx("input",{value:s.group_name,onChange:t=>b({...s,group_name:t.target.value}),placeholder:"Group",className:"w-full rounded-xl border border-input-border bg-input px-3 py-2.5 text-sm placeholder:text-muted outline-none focus:border-primary focus:ring-2 focus:ring-primary/20"})]}),e.jsxs("label",{className:"flex items-center gap-2 text-xs text-muted-foreground",children:[e.jsx("input",{type:"checkbox",checked:$,onChange:t=>re(t.target.checked),className:"h-4 w-4 rounded border-border text-primary focus:ring-primary/30"}),"Close catalog after adding an item"]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs("button",{type:"submit",disabled:w.isPending,className:"flex items-center gap-1.5 rounded-xl bg-primary px-4 py-2 text-sm font-semibold text-primary-foreground shadow-md hover:bg-primary-hover disabled:opacity-50",children:[w.isPending?e.jsx("div",{className:"h-4 w-4 animate-spin rounded-full border-2 border-primary-foreground/30 border-t-primary-foreground"}):e.jsx(W,{size:14}),"Add"]}),e.jsx("button",{type:"button",onClick:F,className:"rounded-xl bg-transparent px-3 py-2 text-sm text-muted-foreground shadow-none hover:text-foreground",children:"Cancel"})]})]}),e.jsxs("div",{className:"rounded-xl border border-border bg-surface/60 p-4",children:[e.jsxs("h3",{className:"mb-3 flex items-center gap-2 font-heading text-sm font-semibold",children:[e.jsx(Qe,{size:15}),"Catalog Picker"]}),e.jsxs("div",{className:"relative mb-3",children:[e.jsx(Re,{size:16,className:"absolute left-3 top-1/2 -translate-y-1/2 text-muted"}),e.jsx("input",{value:g,onChange:t=>l(t.target.value),placeholder:"Search catalog...",className:"w-full rounded-xl border border-input-border bg-input py-2.5 pl-9 pr-3 text-sm placeholder:text-muted outline-none focus:border-primary focus:ring-2 focus:ring-primary/20"})]}),e.jsxs("div",{className:"grid gap-3 lg:grid-cols-5",children:[e.jsxs("div",{className:"space-y-1 lg:col-span-2",children:[e.jsx("p",{className:"text-xs font-semibold uppercase tracking-wide text-muted",children:"Categories"}),e.jsx("div",{className:"max-h-64 space-y-0.5 overflow-auto rounded-lg border border-border bg-background/50 p-2",children:oe?e.jsx("p",{className:"p-2 text-xs text-muted-foreground",children:"Loading..."}):E.length===0?e.jsx("p",{className:"p-2 text-xs text-muted-foreground",children:"No categories"}):E.map(t=>{const c=se.has(t.name),v=S===t.name;return e.jsxs("button",{onClick:()=>{le(t.name),K(t.name),l("")},className:Q("flex w-full items-center gap-2 rounded-lg px-2 py-1.5 text-left text-xs transition-colors",v?"bg-primary/10 text-primary":"text-muted-foreground hover:bg-surface-hover hover:text-foreground"),children:[c?e.jsx(Y,{size:12}):e.jsx(Te,{size:12}),e.jsx("span",{className:"truncate",children:t.name})]},t.name)})})]}),e.jsxs("div",{className:"space-y-1 lg:col-span-3",children:[e.jsx("p",{className:"text-xs font-semibold uppercase tracking-wide text-muted",children:N.length>=2?"Search Results":"Items"}),e.jsx("div",{className:"max-h-64 space-y-1 overflow-auto rounded-lg border border-border bg-background/50 p-2",children:V.length===0?e.jsx("p",{className:"p-2 text-xs text-muted-foreground",children:N.length>=2?"No matching items":"Select a category or search to pick an item"}):V.map(t=>e.jsxs("div",{className:"flex items-center justify-between gap-2 rounded-lg border border-border bg-surface px-2 py-1.5",children:[e.jsxs("div",{className:"min-w-0",children:[e.jsx("p",{className:"truncate text-xs font-medium",children:t.name}),e.jsxs("p",{className:"text-[11px] text-muted-foreground",children:[t.labor_hours??"0","h labor"]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("span",{className:"text-xs font-semibold text-foreground",children:["$",t.unit_price??"0.00"]}),e.jsx("button",{onClick:()=>me(t),disabled:w.isPending,"aria-label":`Add ${t.name}`,className:"rounded-lg bg-primary px-2 py-1 text-[11px] font-semibold text-primary-foreground hover:bg-primary-hover disabled:opacity-50",children:"Add"})]})]},t.id))})]})]})]})]}),_.length===0?e.jsx(ge,{icon:Z,title:"No line items yet",description:"Add items manually or use Quick Start to populate from catalog",action:e.jsxs("button",{onClick:()=>q(!0),className:"flex items-center gap-2 rounded-xl bg-primary px-4 py-2.5 text-sm font-semibold text-primary-foreground shadow-md hover:bg-primary-hover",children:[e.jsx(z,{size:16})," Quick Start from Catalog"]})}):e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"border-b border-border text-left text-xs font-medium uppercase tracking-wider text-muted",children:[e.jsx("th",{className:"py-3 pr-4",children:"Item"}),e.jsx("th",{className:"px-3 py-3 text-right",children:"Qty"}),e.jsx("th",{className:"px-3 py-3 text-right",children:"Price"}),e.jsx("th",{className:"px-3 py-3 text-right",children:"Total"}),e.jsx("th",{className:"px-3 py-3",children:"Group"}),e.jsx("th",{className:"py-3 pl-3 text-right",children:"Actions"})]})}),e.jsx("tbody",{className:"divide-y divide-border",children:_.map((t,c)=>e.jsxs("tr",{className:"group transition-colors hover:bg-surface-hover",children:[e.jsx("td",{className:"py-3 pr-4",children:e.jsx("button",{onClick:()=>L(t),className:"font-medium text-foreground transition-colors hover:text-primary",children:t.item_name})}),e.jsx("td",{className:"px-3 py-3 text-right font-mono",children:t.quantity}),e.jsx("td",{className:"px-3 py-3 text-right font-mono",children:k(t.unit_price)}),e.jsx("td",{className:"px-3 py-3 text-right font-mono font-semibold",children:k(t.total_price)}),e.jsx("td",{className:"px-3 py-3 text-muted-foreground",children:t.group_name||"—"}),e.jsx("td",{className:"py-3 pl-3",children:e.jsxs("div",{className:"flex items-center justify-end gap-1 opacity-0 transition-opacity group-hover:opacity-100",children:[e.jsx("button",{onClick:()=>L(t),className:"rounded-lg bg-transparent p-1.5 text-muted shadow-none transition-colors hover:bg-surface-active hover:text-foreground","aria-label":"Edit",children:e.jsx(X,{size:14})}),e.jsx("button",{onClick:()=>G.mutate({lineItemId:t.id,direction:-1}),disabled:c===0,className:"rounded-lg bg-transparent p-1.5 text-muted shadow-none transition-colors hover:bg-surface-active hover:text-foreground disabled:opacity-30","aria-label":"Move up",children:e.jsx(Ue,{size:14})}),e.jsx("button",{onClick:()=>G.mutate({lineItemId:t.id,direction:1}),disabled:c===_.length-1,className:"rounded-lg bg-transparent p-1.5 text-muted shadow-none transition-colors hover:bg-surface-active hover:text-foreground disabled:opacity-30","aria-label":"Move down",children:e.jsx(Y,{size:14})}),e.jsx("button",{onClick:()=>{confirm(`Remove "${t.item_name}"?`)&&de.mutate(t.id)},className:"rounded-lg bg-transparent p-1.5 text-muted shadow-none transition-colors hover:bg-destructive/10 hover:text-destructive","aria-label":"Delete",children:e.jsx(Ke,{size:14})})]})})]},t.id))})]})})]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"rounded-2xl border border-border bg-surface/80 p-6 backdrop-blur-sm",children:[e.jsx("h3",{className:"mb-4 font-heading text-base font-semibold",children:"Summary"}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{className:"text-muted-foreground",children:"Subtotal"}),e.jsx(D,{value:r.subtotal,size:"sm"})]}),e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsxs("span",{className:"text-muted-foreground",children:["Tax (",r.tax_rate_pct||"0","%)"]}),e.jsx(D,{value:r.tax,size:"sm"})]}),e.jsx("div",{className:"border-t border-border pt-3",children:e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"font-semibold",children:"Total"}),e.jsx(D,{value:r.total,size:"xl",className:"text-primary"})]})})]})]}),e.jsxs("div",{className:"rounded-2xl border border-border bg-surface/80 p-6 backdrop-blur-sm",children:[e.jsx("h3",{className:"mb-4 font-heading text-base font-semibold",children:"Actions"}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("button",{onClick:()=>H.mutate(),disabled:H.isPending,className:"flex w-full items-center gap-2 rounded-xl bg-surface-hover px-4 py-2.5 text-sm font-medium text-foreground shadow-none transition-colors hover:bg-surface-active disabled:opacity-50",children:[e.jsx($e,{size:16,className:"text-muted"})," Recalculate"]}),e.jsxs("button",{onClick:()=>P.mutate("duplicate"),className:"flex w-full items-center gap-2 rounded-xl bg-surface-hover px-4 py-2.5 text-sm font-medium text-foreground shadow-none transition-colors hover:bg-surface-active",children:[e.jsx(Oe,{size:16,className:"text-muted"})," Duplicate"]}),e.jsxs("button",{onClick:()=>P.mutate("version"),className:"flex w-full items-center gap-2 rounded-xl bg-surface-hover px-4 py-2.5 text-sm font-medium text-foreground shadow-none transition-colors hover:bg-surface-active",children:[e.jsx(Be,{size:16,className:"text-muted"})," Create Version"]}),e.jsxs("button",{onClick:()=>J.mutate(),disabled:J.isPending,className:"flex w-full items-center gap-2 rounded-xl bg-surface-hover px-4 py-2.5 text-sm font-medium text-foreground shadow-none transition-colors hover:bg-surface-active disabled:opacity-50",children:[e.jsx(Ge,{size:16,className:"text-muted"})," Export JSON"]}),r.status==="locked"?e.jsxs("button",{onClick:()=>P.mutate("unlock"),className:"flex w-full items-center gap-2 rounded-xl bg-surface-hover px-4 py-2.5 text-sm font-medium text-foreground shadow-none transition-colors hover:bg-surface-active",children:[e.jsx(He,{size:16,className:"text-muted"})," Unlock"]}):e.jsxs("button",{onClick:()=>I.mutate("locked"),className:"flex w-full items-center gap-2 rounded-xl bg-surface-hover px-4 py-2.5 text-sm font-medium text-foreground shadow-none transition-colors hover:bg-surface-active",children:[e.jsx(Je,{size:16,className:"text-muted"})," Lock"]}),e.jsx("div",{className:"border-t border-border pt-2",children:e.jsxs(A,{to:`/estimates/${n}/proposal`,className:"flex w-full items-center gap-2 rounded-xl bg-surface-hover px-4 py-2.5 text-sm font-medium text-foreground transition-colors hover:bg-surface-active",children:[e.jsx(Ve,{size:16,className:"text-muted"})," View Proposal"]})})]})]}),e.jsxs("div",{className:"rounded-2xl border border-border bg-surface/80 p-6 backdrop-blur-sm",children:[e.jsx("h3",{className:"mb-4 font-heading text-base font-semibold",children:"Status"}),e.jsx("div",{className:"grid grid-cols-2 gap-2",children:["draft","in_progress","completed","locked"].map(t=>e.jsx("button",{onClick:()=>I.mutate(t),disabled:r.status===t||I.isPending,className:Q("rounded-xl px-3 py-2 text-xs font-semibold transition-all disabled:opacity-30",r.status===t?"border border-primary/30 bg-primary/10 text-primary":"border border-border bg-surface-hover text-muted-foreground shadow-none hover:text-foreground"),children:be(t)},t))})]}),_.length>0&&e.jsx(Ye,{estimateId:n,lineItems:_,onApplied:y})]})]}),e.jsx(et,{estimateId:n,open:ae,onClose:()=>q(!1)}),O&&e.jsx(tt,{estimateId:n,lineItem:O,onClose:()=>L(null)})]})}export{bt as EstimateDetailPage};
