import{c as L,b as c,u as N,j as e}from"./query-BVapmMUr.js";import{r as _}from"./react-DJjQTIQO.js";import{P as $}from"./PageHeader-o_TcEL5P.js";import{S as F,a as u}from"./LoadingSkeleton-QY-c1bum.js";import{S as g}from"./StatusBadge-DqFGVLZ6.js";import{b as w,E as f,f as S}from"./EmptyState-CZ0oPKrL.js";import{p as C,g as m,u as h}from"./client-Bw5oB_ZD.js";import{c as U,Q as k,C as D,P as T,b as A,V as z,g as Q,R as B,x as P,t as a}from"./ui-D1pQdlX7.js";import"./cn-C8nBGPD0.js";import"./index-D_Pr5PJx.js";import"./state-BAZDGeK2.js";function I(){return m("/admin/summary")}function M(t){const i=new URLSearchParams().toString();return m(`/admin/users${i?`?${i}`:""}`)}function H(t){const r=new URLSearchParams;r.set("limit",String(t.limit)),t!=null&&t.user_id&&r.set("user_id",t.user_id),t!=null&&t.action&&r.set("action",t.action),t!=null&&t.entity_type&&r.set("entity_type",t.entity_type);const i=r.toString();return m(`/admin/activity${i?`?${i}`:""}`)}function V(t){const r=new URLSearchParams;r.set("limit",String(t.limit)),t!=null&&t.user_id&&r.set("user_id",t.user_id),t!=null&&t.event_type&&r.set("event_type",t.event_type);const i=r.toString();return m(`/admin/billing-ledger${i?`?${i}`:""}`)}function W(t){const r=new URLSearchParams;t!=null&&t.retention_days&&r.set("retention_days",String(t.retention_days)),(t==null?void 0:t.dry_run)!==void 0&&r.set("dry_run",String(t.dry_run));const i=r.toString();return C(`/admin/audit-prune${i?`?${i}`:""}`)}function Z(){return C("/admin/demo-reset")}function de(){const t=L(),[r,i]=_.useState(""),[p,q]=_.useState("90"),v=h(s=>s.adminApiKey),R=h(s=>s.setAdminApiKey),E=h(s=>s.clearAdminApiKey),l=v.trim().length>0,{data:d,isLoading:K}=c({queryKey:["admin-summary"],queryFn:I}),{data:x=[]}=c({queryKey:["admin-users"],queryFn:()=>M()}),{data:y=[]}=c({queryKey:["admin-activity"],queryFn:()=>H({limit:20})}),{data:j=[]}=c({queryKey:["admin-billing-ledger"],queryFn:()=>V({limit:20})}),b=N({mutationFn:Z,onSuccess:()=>{t.invalidateQueries(),a.success("Demo data reset"),i("")},onError:s=>a.error(s instanceof Error?s.message:"Reset failed")}),n=N({mutationFn:s=>{const o=Number.parseInt(p,10);return W({retention_days:Number.isFinite(o)&&o>0?o:90,dry_run:s})},onSuccess:(s,o)=>{if(t.invalidateQueries({queryKey:["admin-activity"]}),o){a.success(`Preview: ${s.deleted} records would be pruned`);return}a.success(`Pruned ${s.deleted} records`)},onError:s=>a.error(s instanceof Error?s.message:"Prune failed")});return e.jsxs("div",{className:"space-y-6",children:[e.jsx($,{title:"Admin",description:"System administration and monitoring",icon:U}),e.jsxs("div",{className:"rounded-2xl border border-border bg-surface/80 p-6 backdrop-blur-sm",children:[e.jsx("h2",{className:"mb-2 font-heading text-base font-semibold",children:"Admin API Key"}),e.jsx("p",{className:"mb-4 text-sm text-muted-foreground",children:"Required for destructive admin actions like demo reset and audit prune."}),e.jsxs("div",{className:"flex flex-col gap-3 sm:flex-row",children:[e.jsxs("div",{className:"flex-1 space-y-2",children:[e.jsx("label",{htmlFor:"admin-api-key",className:"text-xs font-medium text-muted-foreground",children:"x-admin-key"}),e.jsx("input",{id:"admin-api-key",type:"password",autoComplete:"off",value:v,onChange:s=>R(s.target.value),placeholder:"Enter admin API key",className:"w-full rounded-xl border border-input-border bg-input px-4 py-3 text-sm placeholder:text-muted outline-none focus:border-primary focus:ring-2 focus:ring-primary/20"})]}),e.jsx("div",{className:"flex items-end",children:e.jsx("button",{onClick:E,disabled:!l,className:"rounded-xl border border-border bg-background/60 px-4 py-3 text-sm text-muted-foreground shadow-none hover:text-foreground disabled:opacity-40",children:"Clear Key"})})]})]}),K?e.jsx("div",{className:"grid gap-4 sm:grid-cols-2 lg:grid-cols-4",children:[1,2,3,4].map(s=>e.jsx(F,{},s))}):d&&e.jsxs("div",{className:"grid gap-4 sm:grid-cols-2 lg:grid-cols-4",children:[e.jsx(u,{label:"Users",value:d.users,icon:k}),e.jsx(u,{label:"Estimates",value:d.estimates,icon:D}),e.jsx(u,{label:"Line Items",value:d.line_items,icon:T}),e.jsx(u,{label:"Billing Total",value:w(d.billing_total_amount),icon:A})]}),e.jsxs("div",{className:"grid gap-6 lg:grid-cols-2",children:[e.jsxs("div",{className:"rounded-2xl border border-border bg-surface/80 p-6 backdrop-blur-sm",children:[e.jsxs("h2",{className:"mb-4 font-heading text-base font-semibold",children:["Users (",x.length,")"]}),x.length===0?e.jsx(f,{icon:k,title:"No users"}):e.jsx("div",{className:"max-h-80 space-y-2 overflow-y-auto",children:x.map(s=>e.jsxs("div",{className:"flex items-center justify-between rounded-xl border border-border bg-background/50 px-4 py-3 transition-colors hover:bg-surface-hover",children:[e.jsxs("div",{className:"min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("p",{className:"truncate text-sm font-medium",children:s.full_name||s.email}),s.stripe_subscription_id&&e.jsx("span",{className:"rounded bg-sky-500/10 px-1.5 py-0.5 text-[10px] font-medium text-sky-500 ring-1 ring-sky-500/20 ring-inset",children:"Stripe Sub"})]}),e.jsxs("div",{className:"mt-0.5 flex flex-col gap-1 text-xs text-muted-foreground",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"truncate",children:s.email}),e.jsx(g,{status:s.role==="admin"?"active":"draft",className:"text-[10px]"})]}),s.stripe_customer_id&&e.jsx("p",{className:"font-mono text-[9px] text-muted-foreground/50",children:s.stripe_customer_id})]})]}),e.jsxs("div",{className:"shrink-0 text-right",children:[e.jsx("p",{className:"text-sm font-medium",children:s.estimates_count}),e.jsx("p",{className:"text-xs text-muted",children:"estimates"})]})]},s.id))})]}),e.jsxs("div",{className:"rounded-2xl border border-border bg-surface/80 p-6 backdrop-blur-sm",children:[e.jsx("h2",{className:"mb-4 font-heading text-base font-semibold",children:"Recent Activity"}),y.length===0?e.jsx(f,{icon:z,title:"No recent activity"}):e.jsx("div",{className:"max-h-80 space-y-1.5 overflow-y-auto",children:y.map(s=>e.jsxs("div",{className:"flex items-center justify-between rounded-xl border border-border bg-background/50 px-4 py-2.5 transition-colors hover:bg-surface-hover",children:[e.jsx("div",{className:"min-w-0",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(g,{status:s.action,size:"sm"}),e.jsxs("span",{className:"truncate text-xs text-muted-foreground",children:["on ",s.entity_type]})]})}),e.jsx("p",{className:"shrink-0 text-xs text-muted",children:S(s.created_at)})]},s.id))})]})]}),e.jsxs("div",{className:"rounded-2xl border border-destructive/30 bg-destructive-muted/30 p-6",children:[e.jsxs("div",{className:"mb-4 flex items-center gap-2",children:[e.jsx(Q,{size:18,className:"text-destructive"}),e.jsx("h2",{className:"font-heading text-base font-semibold text-destructive",children:"Danger Zone"})]}),e.jsxs("div",{className:"grid gap-6 sm:grid-cols-2",children:[e.jsxs("div",{className:"space-y-3 rounded-xl border border-destructive/20 bg-background/30 p-4",children:[e.jsx("h3",{className:"text-sm font-semibold",children:"Demo Reset"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:'Wipe all data and start fresh. Type "RESET" to confirm.'}),e.jsx("input",{value:r,onChange:s=>i(s.target.value),placeholder:'Type "RESET"',className:"w-full rounded-xl border border-input-border bg-input px-3 py-2 text-sm placeholder:text-muted outline-none focus:border-destructive focus:ring-2 focus:ring-destructive/20"}),e.jsxs("button",{onClick:()=>b.mutate(),disabled:r!=="RESET"||b.isPending||!l,className:"flex w-full items-center justify-center gap-2 rounded-xl bg-destructive px-4 py-2.5 text-sm font-semibold text-destructive-foreground shadow-md hover:bg-destructive-hover disabled:opacity-30",children:[b.isPending?e.jsx("div",{className:"h-4 w-4 animate-spin rounded-full border-2 border-destructive-foreground/30 border-t-destructive-foreground"}):e.jsx(B,{size:14}),"Reset Demo"]})]}),e.jsxs("div",{className:"space-y-3 rounded-xl border border-destructive/20 bg-background/30 p-4",children:[e.jsx("h3",{className:"text-sm font-semibold",children:"Audit Prune"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Preview or delete audit records older than retention days."}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"number",value:p,onChange:s=>q(s.target.value),className:"w-full rounded-xl border border-input-border bg-input px-3 py-2 text-sm outline-none focus:border-destructive focus:ring-2 focus:ring-destructive/20"}),e.jsx("span",{className:"shrink-0 text-xs text-muted-foreground",children:"days"})]}),e.jsxs("div",{className:"grid gap-2 sm:grid-cols-2",children:[e.jsxs("button",{onClick:()=>n.mutate(!0),disabled:n.isPending||!l,className:"flex w-full items-center justify-center gap-2 rounded-xl border border-border bg-background/60 px-4 py-2.5 text-sm font-semibold text-foreground shadow-none hover:bg-surface-hover disabled:opacity-30",children:[n.isPending?e.jsx("div",{className:"h-4 w-4 animate-spin rounded-full border-2 border-foreground/30 border-t-foreground"}):e.jsx(P,{size:14}),"Preview"]}),e.jsxs("button",{onClick:()=>n.mutate(!1),disabled:n.isPending||!l,className:"flex w-full items-center justify-center gap-2 rounded-xl border border-destructive/30 bg-destructive/10 px-4 py-2.5 text-sm font-semibold text-destructive shadow-none hover:bg-destructive/20 disabled:opacity-30",children:[n.isPending?e.jsx("div",{className:"h-4 w-4 animate-spin rounded-full border-2 border-destructive/30 border-t-destructive"}):e.jsx(P,{size:14}),"Prune Audit"]})]})]})]})]}),e.jsxs("div",{className:"rounded-2xl border border-border bg-surface/80 p-6 backdrop-blur-sm",children:[e.jsx("h2",{className:"mb-4 font-heading text-base font-semibold",children:"Billing Ledger"}),j.length===0?e.jsx(f,{icon:A,title:"No billing events"}):e.jsx("div",{className:"max-h-80 space-y-2 overflow-y-auto",children:j.map(s=>e.jsx("div",{className:"rounded-xl border border-border bg-background/50 px-4 py-3 transition-colors hover:bg-surface-hover",children:e.jsxs("div",{className:"flex items-center justify-between gap-3",children:[e.jsxs("div",{className:"min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(g,{status:s.event_type,size:"sm"}),e.jsx("span",{className:"truncate text-xs text-muted-foreground",children:s.user_id})]}),s.details&&e.jsx("p",{className:"mt-1 truncate text-xs text-muted-foreground",children:s.details})]}),e.jsxs("div",{className:"shrink-0 text-right",children:[e.jsx("p",{className:"text-sm font-semibold",children:w(s.amount)}),e.jsx("p",{className:"text-xs text-muted",children:S(s.created_at)})]})]})},s.id))})]})]})}export{de as AdminDashboardPage};
