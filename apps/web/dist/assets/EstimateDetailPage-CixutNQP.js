import{b as q,u as b,j as e,c as L}from"./query-BVapmMUr.js";import{r as f,h as G,L as F}from"./react-DJjQTIQO.js";import{P as H}from"./PageHeader-o_TcEL5P.js";import{S as J}from"./StatusBadge-DqFGVLZ6.js";import{M as z}from"./MoneyDisplay-DJnLbf4O.js";import{b as N,E as V,c as Z}from"./EmptyState-CZ0oPKrL.js";import{c as O}from"./cn-C8nBGPD0.js";import{q as X,u as W,a as Y,b as ee,r as te,d as se,e as re,f as ae,v as ne,g as oe,h as ie,s as de,i as le}from"./estimates-D0mYDjU-.js";import{t as m,B as ce,g as me,n as ue,o as xe,p as pe,X as P,Z as _,q as $,r as ge,C as U,s as T,l as K,u as be,v as he,w as fe,R as je,x as ve,G as ye,D as Ne,y as _e,z as ke,H as we}from"./ui--RxPHpVv.js";import{a as Ce,b as Se,g as Ee}from"./llm-4vHwYLeF.js";import{g as Fe}from"./catalog-Wqmak-46.js";import"./client-CZB5FU-Z.js";import"./index-CLC1XlwA.js";import"./state-B9IHhQuw.js";function ze({estimateId:o,lineItems:c,onApplied:r}){const[h,i]=f.useState(null),[j,u]=f.useState(""),{data:n}=q({queryKey:["llm-status"],queryFn:Ee,staleTime:6e4}),d=b({mutationFn:l=>Ce({item_name:l.item_name,current_unit_price:parseFloat(l.unit_price),context:j||void 0})}),a=b({mutationFn:l=>Se({estimate_id:o,line_item_id:l.line_item_id,suggested_price:l.suggested_price}),onSuccess:()=>{m.success("Price suggestion applied"),i(null),d.reset(),r()},onError:l=>m.error(l instanceof Error?l.message:"Apply failed")}),s=c.find(l=>l.id===h),g=(n==null?void 0:n.api_key_configured)&&(n==null?void 0:n.ready_for_live),x=d.data;return e.jsxs("div",{className:"rounded-2xl border border-border bg-surface/80 p-6 backdrop-blur-sm",children:[e.jsxs("div",{className:"mb-4 flex items-center justify-between",children:[e.jsxs("h3",{className:"flex items-center gap-2 font-heading text-base font-semibold",children:[e.jsx(ce,{size:18,className:"text-accent"}),"LLM Assist"]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:O("inline-block h-2 w-2 rounded-full",g?"bg-success":n!=null&&n.simulation_available?"bg-warning":"bg-destructive")}),e.jsx("span",{className:"text-xs text-muted-foreground",children:g?"Live":n!=null&&n.simulation_available?"Simulation":"Offline"})]})]}),(n==null?void 0:n.blocker_reason)&&e.jsxs("div",{className:"mb-3 rounded-xl border border-warning/30 bg-warning-muted px-3 py-2 text-xs text-warning",children:[e.jsx(me,{size:12,className:"mr-1 inline"}),n.blocker_reason]}),e.jsxs("div",{className:"mb-3 space-y-2",children:[e.jsx("label",{className:"text-xs font-medium text-muted-foreground",children:"Select line item"}),e.jsxs("select",{value:h||"",onChange:l=>{i(l.target.value||null),d.reset()},className:"w-full rounded-xl border border-input-border bg-input px-3 py-2.5 text-sm outline-none focus:border-primary focus:ring-2 focus:ring-primary/20",children:[e.jsx("option",{value:"",children:"Choose an item..."}),c.map(l=>e.jsxs("option",{value:l.id,children:[l.item_name," — ",N(l.unit_price)]},l.id))]})]}),e.jsxs("div",{className:"mb-3 space-y-2",children:[e.jsx("label",{className:"text-xs font-medium text-muted-foreground",children:"Context (optional)"}),e.jsx("input",{value:j,onChange:l=>u(l.target.value),placeholder:"e.g. mid-range, commercial grade",className:"w-full rounded-xl border border-input-border bg-input px-3 py-2.5 text-sm placeholder:text-muted outline-none focus:border-primary focus:ring-2 focus:ring-primary/20"})]}),e.jsxs("button",{disabled:!s||d.isPending,onClick:()=>s&&d.mutate(s),className:"flex w-full items-center justify-center gap-2 rounded-xl bg-accent/15 px-4 py-2.5 text-sm font-semibold text-accent shadow-none transition-colors hover:bg-accent/25 disabled:opacity-40",children:[d.isPending?e.jsx(ue,{size:16,className:"animate-spin"}):e.jsx(xe,{size:16}),"Get Price Suggestion"]}),x&&e.jsxs("div",{className:"mt-4 rounded-xl border border-accent/20 bg-accent/5 p-4",children:[e.jsxs("div",{className:"mb-3 flex items-center justify-between",children:[e.jsx("span",{className:"text-xs font-medium uppercase tracking-wider text-muted",children:"Suggestion"}),x.confidence&&e.jsxs("span",{className:"rounded-full bg-accent/15 px-2 py-0.5 text-xs font-semibold text-accent",children:[x.confidence," confidence"]})]}),e.jsxs("div",{className:"mb-2 grid grid-cols-2 gap-2 text-sm",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-muted-foreground",children:"Current"}),e.jsx("p",{className:"font-mono font-semibold",children:N(x.current_unit_price)})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-muted-foreground",children:"Suggested"}),e.jsx("p",{className:"font-mono font-semibold text-accent",children:N(x.suggested_unit_price)})]})]}),x.rationale&&e.jsx("p",{className:"mb-3 text-xs text-muted-foreground",children:x.rationale}),x.provider&&e.jsxs("p",{className:"mb-3 text-xs text-muted",children:["via ",x.provider,"/",x.model," (",x.mode,")"]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs("button",{onClick:()=>a.mutate({line_item_id:h,suggested_price:parseFloat(x.suggested_unit_price)}),disabled:a.isPending,className:"flex flex-1 items-center justify-center gap-1.5 rounded-xl bg-accent px-3 py-2 text-xs font-semibold text-accent-foreground shadow-md transition-colors hover:bg-accent/90 disabled:opacity-50",children:[e.jsx(pe,{size:14})," Apply"]}),e.jsxs("button",{onClick:()=>d.reset(),className:"flex items-center gap-1.5 rounded-xl bg-surface-hover px-3 py-2 text-xs font-medium text-muted-foreground shadow-none transition-colors hover:text-foreground",children:[e.jsx(P,{size:14})," Dismiss"]})]})]}),d.isError&&e.jsx("div",{className:"mt-3 rounded-xl border border-destructive/20 bg-destructive-muted px-3 py-2 text-xs text-destructive",children:d.error instanceof Error?d.error.message:"Suggestion failed"})]})}function qe({estimateId:o,open:c,onClose:r}){const h=L(),[i,j]=f.useState(""),[u,n]=f.useState("10"),{data:d=[]}=q({queryKey:["catalog-tree"],queryFn:Fe,enabled:c}),a=b({mutationFn:()=>X(o,{catalog_node_name:i,max_items:parseInt(u)||void 0}),onSuccess:()=>{h.invalidateQueries({queryKey:["estimate",o]}),h.invalidateQueries({queryKey:["estimates"]}),m.success("Starter items added!"),r()},onError:s=>m.error(s instanceof Error?s.message:"Quickstart failed")});return c?e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-background/80 backdrop-blur-sm",children:e.jsxs("div",{className:"w-full max-w-md rounded-2xl border border-border bg-surface p-6 shadow-lg",children:[e.jsxs("div",{className:"mb-4 flex items-center justify-between",children:[e.jsxs("h3",{className:"flex items-center gap-2 font-heading text-lg font-semibold",children:[e.jsx(_,{size:20,className:"text-warning"}),"Quick Start"]}),e.jsx("button",{onClick:r,className:"rounded-lg bg-transparent p-1.5 text-muted shadow-none transition-colors hover:bg-surface-hover hover:text-foreground",children:e.jsx(P,{size:18})})]}),e.jsx("p",{className:"mb-4 text-sm text-muted-foreground",children:"Populate this estimate with common items from a catalog category."}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium",children:"Room / Category"}),e.jsxs("select",{value:i,onChange:s=>j(s.target.value),className:"w-full rounded-xl border border-input-border bg-input px-4 py-3 text-sm outline-none focus:border-primary focus:ring-2 focus:ring-primary/20",children:[e.jsx("option",{value:"",children:"Select a category..."}),d.map(s=>e.jsxs("option",{value:s.name,children:[s.name," (",s.items.length," items)"]},s.name))]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium",children:"Max Items"}),e.jsx("input",{type:"number",min:"1",max:"50",value:u,onChange:s=>n(s.target.value),className:"w-full rounded-xl border border-input-border bg-input px-4 py-3 text-sm outline-none focus:border-primary focus:ring-2 focus:ring-primary/20"})]}),e.jsxs("div",{className:"flex gap-3 pt-2",children:[e.jsxs("button",{onClick:()=>a.mutate(),disabled:!i||a.isPending,className:"flex flex-1 items-center justify-center gap-2 rounded-xl bg-primary px-4 py-3 text-sm font-semibold text-primary-foreground shadow-lg shadow-primary/20 transition-all hover:bg-primary-hover disabled:opacity-50",children:[a.isPending?e.jsx("div",{className:"h-4 w-4 animate-spin rounded-full border-2 border-primary-foreground/30 border-t-primary-foreground"}):e.jsx(_,{size:16}),"Add Items"]}),e.jsx("button",{onClick:r,className:"rounded-xl bg-transparent px-4 py-3 text-sm font-medium text-muted-foreground shadow-none transition-colors hover:text-foreground",children:"Cancel"})]})]})]})}):null}function Le({estimateId:o,lineItem:c,onClose:r}){const h=L(),[i,j]=f.useState({quantity:c.quantity,unit_price:c.unit_price,item_markup_pct:c.item_markup_pct,labor_hours:c.labor_hours,labor_rate:c.labor_rate,discount_value:c.discount_value,discount_is_percent:c.discount_is_percent,group_name:c.group_name}),u=b({mutationFn:()=>W(o,c.id,{quantity:parseFloat(i.quantity)||void 0,unit_price:parseFloat(i.unit_price)||void 0,item_markup_pct:parseFloat(i.item_markup_pct)||void 0,labor_hours:parseFloat(i.labor_hours)||void 0,discount_value:parseFloat(i.discount_value)||void 0,discount_is_percent:i.discount_is_percent,group_name:i.group_name||void 0}),onSuccess:()=>{h.invalidateQueries({queryKey:["estimate",o]}),h.invalidateQueries({queryKey:["estimates"]}),m.success(`${c.item_name} updated`),r()},onError:a=>m.error(a instanceof Error?a.message:"Update failed")}),n=(a,s)=>{j(g=>({...g,[a]:s}))},d="w-full rounded-xl border border-input-border bg-input px-3 py-2.5 text-sm outline-none transition-colors focus:border-primary focus:ring-2 focus:ring-primary/20";return e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-background/80 backdrop-blur-sm",children:e.jsxs("div",{className:"w-full max-w-lg rounded-2xl border border-border bg-surface p-6 shadow-lg",children:[e.jsxs("div",{className:"mb-4 flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"font-heading text-lg font-semibold",children:c.item_name}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:["Current total: ",N(c.total_price)]})]}),e.jsx("button",{onClick:r,className:"rounded-lg bg-transparent p-1.5 text-muted shadow-none transition-colors hover:bg-surface-hover hover:text-foreground",children:e.jsx(P,{size:18})})]}),e.jsxs("form",{onSubmit:a=>{a.preventDefault(),u.mutate()},className:"space-y-4",children:[e.jsxs("div",{className:"grid gap-4 sm:grid-cols-2",children:[e.jsxs("div",{className:"space-y-1.5",children:[e.jsx("label",{className:"text-xs font-medium text-muted-foreground",children:"Quantity"}),e.jsx("input",{type:"number",step:"any",value:i.quantity,onChange:a=>n("quantity",a.target.value),className:d})]}),e.jsxs("div",{className:"space-y-1.5",children:[e.jsx("label",{className:"text-xs font-medium text-muted-foreground",children:"Unit Price ($)"}),e.jsx("input",{type:"number",step:"0.01",value:i.unit_price,onChange:a=>n("unit_price",a.target.value),className:d})]}),e.jsxs("div",{className:"space-y-1.5",children:[e.jsx("label",{className:"text-xs font-medium text-muted-foreground",children:"Markup %"}),e.jsx("input",{type:"number",step:"any",value:i.item_markup_pct,onChange:a=>n("item_markup_pct",a.target.value),className:d})]}),e.jsxs("div",{className:"space-y-1.5",children:[e.jsx("label",{className:"text-xs font-medium text-muted-foreground",children:"Labor Hours"}),e.jsx("input",{type:"number",step:"any",value:i.labor_hours,onChange:a=>n("labor_hours",a.target.value),className:d})]}),e.jsxs("div",{className:"space-y-1.5",children:[e.jsx("label",{className:"text-xs font-medium text-muted-foreground",children:"Discount"}),e.jsx("input",{type:"number",step:"any",value:i.discount_value,onChange:a=>n("discount_value",a.target.value),className:d})]}),e.jsxs("div",{className:"space-y-1.5",children:[e.jsx("label",{className:"text-xs font-medium text-muted-foreground",children:"Discount Type"}),e.jsxs("select",{value:i.discount_is_percent?"percent":"flat",onChange:a=>n("discount_is_percent",a.target.value==="percent"),className:d,children:[e.jsx("option",{value:"flat",children:"Flat ($)"}),e.jsx("option",{value:"percent",children:"Percent (%)"})]})]})]}),e.jsxs("div",{className:"space-y-1.5",children:[e.jsx("label",{className:"text-xs font-medium text-muted-foreground",children:"Group"}),e.jsx("input",{value:i.group_name,onChange:a=>n("group_name",a.target.value),placeholder:"e.g. Plumbing",className:d})]}),e.jsxs("div",{className:"flex gap-3 pt-2",children:[e.jsxs("button",{type:"submit",disabled:u.isPending,className:"flex flex-1 items-center justify-center gap-2 rounded-xl bg-primary px-4 py-3 text-sm font-semibold text-primary-foreground shadow-lg shadow-primary/20 transition-all hover:bg-primary-hover disabled:opacity-50",children:[u.isPending?e.jsx("div",{className:"h-4 w-4 animate-spin rounded-full border-2 border-primary-foreground/30 border-t-primary-foreground"}):e.jsx($,{size:16}),"Save Changes"]}),e.jsx("button",{type:"button",onClick:r,className:"rounded-xl bg-transparent px-4 py-3 text-sm font-medium text-muted-foreground shadow-none transition-colors hover:text-foreground",children:"Cancel"})]})]})]})})}function He(){const{id:o}=G(),c=L(),{data:r,isLoading:h}=q({queryKey:["estimate",o],queryFn:()=>le(o),enabled:!!o}),[i,j]=f.useState(!1),[u,n]=f.useState({customer_name:"",customer_email:"",customer_phone:"",job_address:"",estimate_markup_pct:"",tax_rate_pct:""}),[d,a]=f.useState(!1),[s,g]=f.useState({item_name:"",quantity:"",unit_price:"",labor_hours:"0",item_markup_pct:"0",discount_value:"0",group_name:""}),[x,l]=f.useState(!1),[M,k]=f.useState(null),v=()=>{c.invalidateQueries({queryKey:["estimate",o]}),c.invalidateQueries({queryKey:["estimates"]})},I=b({mutationFn:t=>Y(o,t),onSuccess:()=>{v(),j(!1),m.success("Estimate updated")},onError:t=>m.error(t instanceof Error?t.message:"Update failed")}),w=b({mutationFn:t=>ee(o,t),onSuccess:()=>{v(),a(!1),g({item_name:"",quantity:"",unit_price:"",labor_hours:"0",item_markup_pct:"0",discount_value:"0",group_name:""}),m.success("Line item added")},onError:t=>m.error(t instanceof Error?t.message:"Failed to add item")}),B=b({mutationFn:t=>se(o,t),onSuccess:()=>{v(),m.success("Line item removed")},onError:t=>m.error(t instanceof Error?t.message:"Failed to remove item")}),Q=b({mutationFn:({lineItemId:t,direction:p})=>te(o,t,p),onSuccess:()=>v()}),D=b({mutationFn:()=>re(o),onSuccess:()=>{v(),m.success("Totals recalculated")},onError:t=>m.error(t instanceof Error?t.message:"Recalc failed")}),A=b({mutationFn:()=>ie(o),onSuccess:t=>{const p=new Blob([JSON.stringify(t,null,2)],{type:"application/json"}),R=URL.createObjectURL(p),E=document.createElement("a");E.href=R,E.download=`estimate-${o}.json`,E.click(),URL.revokeObjectURL(R),m.success("Estimate exported")},onError:t=>m.error(t instanceof Error?t.message:"Export failed")}),C=b({mutationFn:t=>{switch(t){case"duplicate":return oe(o);case"version":return ne(o);case"unlock":return ae(o);default:return Promise.reject(new Error("Unknown action"))}},onSuccess:(t,p)=>{v(),m.success(`Estimate ${p==="duplicate"?"duplicated":p==="version"?"versioned":"unlocked"}`)},onError:t=>m.error(t instanceof Error?t.message:"Action failed")}),S=b({mutationFn:t=>de(o,t),onSuccess:()=>{v(),m.success("Status updated")},onError:t=>m.error(t instanceof Error?t.message:"Status update failed")});if(h)return e.jsxs("div",{className:"space-y-6",children:[e.jsx("div",{className:"animate-skeleton h-10 w-1/3 rounded-xl bg-border"}),e.jsxs("div",{className:"grid gap-6 lg:grid-cols-3",children:[e.jsxs("div",{className:"space-y-6 lg:col-span-2",children:[e.jsx("div",{className:"animate-skeleton h-48 rounded-2xl bg-border"}),e.jsx("div",{className:"animate-skeleton h-72 rounded-2xl bg-border"})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"animate-skeleton h-40 rounded-2xl bg-border"}),e.jsx("div",{className:"animate-skeleton h-56 rounded-2xl bg-border"})]})]})]});if(!r)return e.jsxs("div",{className:"flex flex-col items-center py-20 text-center",children:[e.jsx("p",{className:"text-lg text-muted-foreground",children:"Estimate not found"}),e.jsx(F,{to:"/estimates",className:"mt-4 text-sm text-primary hover:underline",children:"Back to estimates"})]});const y=r.line_items||[];return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(F,{to:"/estimates",className:"rounded-lg p-2 text-muted transition-colors hover:bg-surface-hover hover:text-foreground",children:e.jsx(ge,{size:20})}),e.jsx(H,{title:r.title,icon:U,actions:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(J,{status:r.status,size:"md"}),e.jsxs("span",{className:"font-mono text-sm text-muted-foreground",children:["v",r.version]})]})})]}),e.jsxs("div",{className:"grid gap-6 lg:grid-cols-3",children:[e.jsxs("div",{className:"space-y-6 lg:col-span-2",children:[e.jsxs("div",{className:"rounded-2xl border border-border bg-surface/80 p-6 backdrop-blur-sm",children:[e.jsxs("div",{className:"mb-4 flex items-center justify-between",children:[e.jsx("h2",{className:"font-heading text-base font-semibold",children:"Customer & Project"}),e.jsx("button",{onClick:()=>{i||n({customer_name:r.customer_name||"",customer_email:r.customer_email||"",customer_phone:r.customer_phone||"",job_address:r.job_address||"",estimate_markup_pct:r.estimate_markup_pct||"",tax_rate_pct:r.tax_rate_pct||""}),j(!i)},className:"rounded-lg bg-transparent p-2 text-muted shadow-none transition-colors hover:bg-surface-hover hover:text-foreground",children:e.jsx(T,{size:16})})]}),i?e.jsxs("form",{onSubmit:t=>{t.preventDefault(),I.mutate({customer_name:u.customer_name,customer_email:u.customer_email,customer_phone:u.customer_phone,job_address:u.job_address,estimate_markup_pct:u.estimate_markup_pct?parseFloat(u.estimate_markup_pct):void 0,tax_rate_pct:u.tax_rate_pct?parseFloat(u.tax_rate_pct):void 0})},className:"space-y-3",children:[e.jsx("div",{className:"grid gap-3 sm:grid-cols-2",children:["customer_name","customer_email","customer_phone","job_address","estimate_markup_pct","tax_rate_pct"].map(t=>e.jsx("input",{value:u[t],onChange:p=>n({...u,[t]:p.target.value}),placeholder:t.replace(/_/g," ").replace(/\b\w/g,p=>p.toUpperCase()),className:"w-full rounded-xl border border-input-border bg-input px-4 py-2.5 text-sm text-foreground placeholder:text-muted outline-none focus:border-primary focus:ring-2 focus:ring-primary/20"},t))}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs("button",{type:"submit",disabled:I.isPending,className:"flex items-center gap-2 rounded-xl bg-primary px-4 py-2 text-sm font-semibold text-primary-foreground shadow-md hover:bg-primary-hover disabled:opacity-50",children:[e.jsx($,{size:14})," Save"]}),e.jsx("button",{type:"button",onClick:()=>j(!1),className:"rounded-xl bg-transparent px-4 py-2 text-sm text-muted-foreground shadow-none hover:text-foreground",children:"Cancel"})]})]}):e.jsxs("div",{className:"grid gap-x-8 gap-y-2 text-sm sm:grid-cols-2",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-muted-foreground",children:"Customer:"})," ",e.jsx("span",{className:"font-medium",children:r.customer_name||"—"})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-muted-foreground",children:"Email:"})," ",e.jsx("span",{className:"font-medium",children:r.customer_email||"—"})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-muted-foreground",children:"Phone:"})," ",e.jsx("span",{className:"font-medium",children:r.customer_phone||"—"})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-muted-foreground",children:"Address:"})," ",e.jsx("span",{className:"font-medium",children:r.job_address||"—"})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-muted-foreground",children:"Markup:"})," ",e.jsxs("span",{className:"font-medium",children:[r.estimate_markup_pct||"0","%"]})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-muted-foreground",children:"Tax Rate:"})," ",e.jsxs("span",{className:"font-medium",children:[r.tax_rate_pct||"0","%"]})]})]})]}),e.jsxs("div",{className:"rounded-2xl border border-border bg-surface/80 p-6 backdrop-blur-sm",children:[e.jsxs("div",{className:"mb-4 flex items-center justify-between",children:[e.jsxs("h2",{className:"font-heading text-base font-semibold",children:["Line Items (",y.length,")"]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("button",{onClick:()=>l(!0),className:"flex items-center gap-1.5 rounded-xl border border-warning/30 bg-warning/10 px-3 py-2 text-xs font-semibold text-warning shadow-none transition-colors hover:bg-warning/20",children:[e.jsx(_,{size:14})," Quick Start"]}),e.jsxs("button",{onClick:()=>a(!d),className:"flex items-center gap-1.5 rounded-xl bg-primary px-3 py-2 text-xs font-semibold text-primary-foreground shadow-md hover:bg-primary-hover",children:[e.jsx(K,{size:14})," Add Item"]})]})]}),d&&e.jsxs("form",{onSubmit:t=>{t.preventDefault(),w.mutate({item_name:s.item_name,quantity:parseFloat(s.quantity)||1,unit_price:parseFloat(s.unit_price)||0,labor_hours:parseFloat(s.labor_hours)||0,item_markup_pct:parseFloat(s.item_markup_pct)||0,discount_value:parseFloat(s.discount_value)||0,group_name:s.group_name||void 0})},className:"mb-4 space-y-3 rounded-xl border border-primary/20 bg-background/50 p-4",children:[e.jsxs("div",{className:"grid gap-3 sm:grid-cols-3",children:[e.jsx("input",{value:s.item_name,onChange:t=>g({...s,item_name:t.target.value}),placeholder:"Item name *",required:!0,className:"w-full rounded-xl border border-input-border bg-input px-3 py-2.5 text-sm placeholder:text-muted outline-none focus:border-primary focus:ring-2 focus:ring-primary/20"}),e.jsx("input",{value:s.quantity,onChange:t=>g({...s,quantity:t.target.value}),placeholder:"Quantity",type:"number",step:"any",className:"w-full rounded-xl border border-input-border bg-input px-3 py-2.5 text-sm placeholder:text-muted outline-none focus:border-primary focus:ring-2 focus:ring-primary/20"}),e.jsx("input",{value:s.unit_price,onChange:t=>g({...s,unit_price:t.target.value}),placeholder:"Unit price",type:"number",step:"0.01",className:"w-full rounded-xl border border-input-border bg-input px-3 py-2.5 text-sm placeholder:text-muted outline-none focus:border-primary focus:ring-2 focus:ring-primary/20"})]}),e.jsxs("div",{className:"grid gap-3 sm:grid-cols-3",children:[e.jsx("input",{value:s.labor_hours,onChange:t=>g({...s,labor_hours:t.target.value}),placeholder:"Labor hours",type:"number",step:"any",className:"w-full rounded-xl border border-input-border bg-input px-3 py-2.5 text-sm placeholder:text-muted outline-none focus:border-primary focus:ring-2 focus:ring-primary/20"}),e.jsx("input",{value:s.item_markup_pct,onChange:t=>g({...s,item_markup_pct:t.target.value}),placeholder:"Markup %",type:"number",step:"any",className:"w-full rounded-xl border border-input-border bg-input px-3 py-2.5 text-sm placeholder:text-muted outline-none focus:border-primary focus:ring-2 focus:ring-primary/20"}),e.jsx("input",{value:s.group_name,onChange:t=>g({...s,group_name:t.target.value}),placeholder:"Group",className:"w-full rounded-xl border border-input-border bg-input px-3 py-2.5 text-sm placeholder:text-muted outline-none focus:border-primary focus:ring-2 focus:ring-primary/20"})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs("button",{type:"submit",disabled:w.isPending,className:"flex items-center gap-1.5 rounded-xl bg-primary px-4 py-2 text-sm font-semibold text-primary-foreground shadow-md hover:bg-primary-hover disabled:opacity-50",children:[w.isPending?e.jsx("div",{className:"h-4 w-4 animate-spin rounded-full border-2 border-primary-foreground/30 border-t-primary-foreground"}):e.jsx(K,{size:14}),"Add"]}),e.jsx("button",{type:"button",onClick:()=>a(!1),className:"rounded-xl bg-transparent px-3 py-2 text-sm text-muted-foreground shadow-none hover:text-foreground",children:"Cancel"})]})]}),y.length===0?e.jsx(V,{icon:U,title:"No line items yet",description:"Add items manually or use Quick Start to populate from catalog",action:e.jsxs("button",{onClick:()=>l(!0),className:"flex items-center gap-2 rounded-xl bg-primary px-4 py-2.5 text-sm font-semibold text-primary-foreground shadow-md hover:bg-primary-hover",children:[e.jsx(_,{size:16})," Quick Start from Catalog"]})}):e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"border-b border-border text-left text-xs font-medium uppercase tracking-wider text-muted",children:[e.jsx("th",{className:"py-3 pr-4",children:"Item"}),e.jsx("th",{className:"px-3 py-3 text-right",children:"Qty"}),e.jsx("th",{className:"px-3 py-3 text-right",children:"Price"}),e.jsx("th",{className:"px-3 py-3 text-right",children:"Total"}),e.jsx("th",{className:"px-3 py-3",children:"Group"}),e.jsx("th",{className:"py-3 pl-3 text-right",children:"Actions"})]})}),e.jsx("tbody",{className:"divide-y divide-border",children:y.map((t,p)=>e.jsxs("tr",{className:"group transition-colors hover:bg-surface-hover",children:[e.jsx("td",{className:"py-3 pr-4",children:e.jsx("button",{onClick:()=>k(t),className:"font-medium text-foreground transition-colors hover:text-primary",children:t.item_name})}),e.jsx("td",{className:"px-3 py-3 text-right font-mono",children:t.quantity}),e.jsx("td",{className:"px-3 py-3 text-right font-mono",children:N(t.unit_price)}),e.jsx("td",{className:"px-3 py-3 text-right font-mono font-semibold",children:N(t.total_price)}),e.jsx("td",{className:"px-3 py-3 text-muted-foreground",children:t.group_name||"—"}),e.jsx("td",{className:"py-3 pl-3",children:e.jsxs("div",{className:"flex items-center justify-end gap-1 opacity-0 transition-opacity group-hover:opacity-100",children:[e.jsx("button",{onClick:()=>k(t),className:"rounded-lg bg-transparent p-1.5 text-muted shadow-none transition-colors hover:bg-surface-active hover:text-foreground","aria-label":"Edit",children:e.jsx(T,{size:14})}),e.jsx("button",{onClick:()=>Q.mutate({lineItemId:t.id,direction:-1}),disabled:p===0,className:"rounded-lg bg-transparent p-1.5 text-muted shadow-none transition-colors hover:bg-surface-active hover:text-foreground disabled:opacity-30","aria-label":"Move up",children:e.jsx(be,{size:14})}),e.jsx("button",{onClick:()=>Q.mutate({lineItemId:t.id,direction:1}),disabled:p===y.length-1,className:"rounded-lg bg-transparent p-1.5 text-muted shadow-none transition-colors hover:bg-surface-active hover:text-foreground disabled:opacity-30","aria-label":"Move down",children:e.jsx(he,{size:14})}),e.jsx("button",{onClick:()=>{confirm(`Remove "${t.item_name}"?`)&&B.mutate(t.id)},className:"rounded-lg bg-transparent p-1.5 text-muted shadow-none transition-colors hover:bg-destructive/10 hover:text-destructive","aria-label":"Delete",children:e.jsx(fe,{size:14})})]})})]},t.id))})]})})]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"rounded-2xl border border-border bg-surface/80 p-6 backdrop-blur-sm",children:[e.jsx("h3",{className:"mb-4 font-heading text-base font-semibold",children:"Summary"}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{className:"text-muted-foreground",children:"Subtotal"}),e.jsx(z,{value:r.subtotal,size:"sm"})]}),e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsxs("span",{className:"text-muted-foreground",children:["Tax (",r.tax_rate_pct||"0","%)"]}),e.jsx(z,{value:r.tax,size:"sm"})]}),e.jsx("div",{className:"border-t border-border pt-3",children:e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"font-semibold",children:"Total"}),e.jsx(z,{value:r.total,size:"xl",className:"text-primary"})]})})]})]}),e.jsxs("div",{className:"rounded-2xl border border-border bg-surface/80 p-6 backdrop-blur-sm",children:[e.jsx("h3",{className:"mb-4 font-heading text-base font-semibold",children:"Actions"}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("button",{onClick:()=>D.mutate(),disabled:D.isPending,className:"flex w-full items-center gap-2 rounded-xl bg-surface-hover px-4 py-2.5 text-sm font-medium text-foreground shadow-none transition-colors hover:bg-surface-active disabled:opacity-50",children:[e.jsx(je,{size:16,className:"text-muted"})," Recalculate"]}),e.jsxs("button",{onClick:()=>C.mutate("duplicate"),className:"flex w-full items-center gap-2 rounded-xl bg-surface-hover px-4 py-2.5 text-sm font-medium text-foreground shadow-none transition-colors hover:bg-surface-active",children:[e.jsx(ve,{size:16,className:"text-muted"})," Duplicate"]}),e.jsxs("button",{onClick:()=>C.mutate("version"),className:"flex w-full items-center gap-2 rounded-xl bg-surface-hover px-4 py-2.5 text-sm font-medium text-foreground shadow-none transition-colors hover:bg-surface-active",children:[e.jsx(ye,{size:16,className:"text-muted"})," Create Version"]}),e.jsxs("button",{onClick:()=>A.mutate(),disabled:A.isPending,className:"flex w-full items-center gap-2 rounded-xl bg-surface-hover px-4 py-2.5 text-sm font-medium text-foreground shadow-none transition-colors hover:bg-surface-active disabled:opacity-50",children:[e.jsx(Ne,{size:16,className:"text-muted"})," Export JSON"]}),r.status==="locked"?e.jsxs("button",{onClick:()=>C.mutate("unlock"),className:"flex w-full items-center gap-2 rounded-xl bg-surface-hover px-4 py-2.5 text-sm font-medium text-foreground shadow-none transition-colors hover:bg-surface-active",children:[e.jsx(_e,{size:16,className:"text-muted"})," Unlock"]}):e.jsxs("button",{onClick:()=>S.mutate("locked"),className:"flex w-full items-center gap-2 rounded-xl bg-surface-hover px-4 py-2.5 text-sm font-medium text-foreground shadow-none transition-colors hover:bg-surface-active",children:[e.jsx(ke,{size:16,className:"text-muted"})," Lock"]}),e.jsx("div",{className:"border-t border-border pt-2",children:e.jsxs(F,{to:`/estimates/${o}/proposal`,className:"flex w-full items-center gap-2 rounded-xl bg-surface-hover px-4 py-2.5 text-sm font-medium text-foreground transition-colors hover:bg-surface-active",children:[e.jsx(we,{size:16,className:"text-muted"})," View Proposal"]})})]})]}),e.jsxs("div",{className:"rounded-2xl border border-border bg-surface/80 p-6 backdrop-blur-sm",children:[e.jsx("h3",{className:"mb-4 font-heading text-base font-semibold",children:"Status"}),e.jsx("div",{className:"grid grid-cols-2 gap-2",children:["draft","in_progress","completed","locked"].map(t=>e.jsx("button",{onClick:()=>S.mutate(t),disabled:r.status===t||S.isPending,className:O("rounded-xl px-3 py-2 text-xs font-semibold transition-all disabled:opacity-30",r.status===t?"border border-primary/30 bg-primary/10 text-primary":"border border-border bg-surface-hover text-muted-foreground shadow-none hover:text-foreground"),children:Z(t)},t))})]}),y.length>0&&e.jsx(ze,{estimateId:o,lineItems:y,onApplied:v})]})]}),e.jsx(qe,{estimateId:o,open:x,onClose:()=>l(!1)}),M&&e.jsx(Le,{estimateId:o,lineItem:M,onClose:()=>k(null)})]})}export{He as EstimateDetailPage};
